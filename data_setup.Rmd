---
title: "data_setup"
author: "Micah GVI"
date: "04/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r package load, warning=FALSE, message=FALSE}
library(BiocManager)
library(annotate)
library(ape)
library(ggtree)
library(seqinr)
library(Biostrings)
library(wesanderson)
library(viridis)
library(ggplot2)
library(stringi)
library(treeio)
```


### Amino acid sequence code ####
```{r pressure, echo=FALSE}
seq <- readAAStringSet("./input/master_aa_seqs.fa")
seqDF <- data.frame(seq)
names(seqDF) <- c("seq")
seqDF <- cbind("WNV Variant" = rownames(seqDF), seqDF)

cpro_seq<- unlist(substr(seqDF$seq, start = 6, stop = 123))
cprodf <- cbind("WNV Variant" = rownames(seqDF), cpro_seq)
cprodf <- as.data.frame(cprodf)
cproAA<-sapply(cprodf$cpro_seq,strsplit,split="")
names(cproAA) <- seqDF$`WNV Variant`
cproAA <- as.AAbin(cproAA)

prMpro_seq <- unlist(substr(seqDF$seq, start = 217, stop = 290))
prMprodf <- cbind("WNV Variant" = rownames(seqDF), prMpro_seq)
prMprodf <- as.data.frame(prMprodf)
prMproAA<-sapply(prMprodf$prMpro_seq,strsplit,split="")
names(prMproAA) <- seqDF$`WNV Variant`
prMproAA <- as.AAbin(prMproAA)

epro_seq <- unlist(substr(seqDF$seq, start = 598, stop = 791))
eprodf <- cbind("WNV Variant" = rownames(seqDF), epro_seq)
eprodf <- as.data.frame(eprodf)
eproAA<-sapply(eprodf$epro_seq,strsplit,split="")
names(eproAA) <- seqDF$`WNV Variant`
eproAA <- as.AAbin(eproAA)
```


```{r}
seqAlign<-muscle(seqAA,quiet=F)
alview(seqAlign)
monopic <- image.AAbin(seqAlign, bg = (wes_palette("Darjeeling1")[5]), col = wes_palette("Darjeeling1"), ylab = "WNV Variants", xlab = "Sequence Length", show.labels = T, cex.lab = 0.5, legend = T, aa.cex = 0.8)
```

```{r}
# Check sequence length - keep only if length is greater than 3000 AAs
SeqLen<-as.numeric(lapply(fullseqAA,length))
qplot(SeqLen, binwidth = 50)+theme_bw()

KeepSeq<-SeqLen>3000
seqAA<-seqAlign[KeepSeq,]
```

```{r}
## Generate a distance matrix.

seqDM<-dist.aa(seqAlign) # generate distance matrix based on AA sequences.
class(seqDM) # Dist
length(seqDM) # 2346

seqDMmat<-as.matrix(seqDM) # convert to matrix format.
dim(seqDMmat) # 69 x 69

## Melt to a linear matrix.
library(reshape2)
DMMat<-melt(seqDMmat) # Linear matrix.
ggplot(data=DMMat,aes(x=Var1,y=Var2,fill=value)) + geom_tile() + scale_fill_gradientn(colours=c("white","blue","green","red")) # Visualization not working.
```
#### Group Vector Information and create Phylogeny

```{r}
PhyloTree = nj(seqDM) #Build a phylogeny using neighbour-joining method <- <- 
```

```{r}

#Use regex and stringi to select strain vector from dataset
Vect = stri_extract_all(PhyloTree$tip.label, regex= "Culex|Homo sapiens|Culiseta|Corvus|Aves|Aedes|Culicidae",
                        mode = "all", simplify =TRUE) 
Vect<-sub("\\w+\\s+\\|(\\w+|\\w+\\s\\w+)\\|(\\w+|\\w+\\s\\w+)\\|.+","\\1",PhyloTree$tip.label) #uses regex to capture country 

Groups = split(PhyloTree$tip.label, Vect) #Separate vector from strain name

col = groupOTU(PhyloTree,Groups) #Create a group composed of vectors

str(col) #Display "col" information to ensure groups were properly formed

```

```{r}
ggtree(col, layout="rectangular", aes(color = group))
```

```{r}
#Two genomes were missing the country, so I checked the research papers where the data was published and added in the missing countries to our dataset (Kenya and Czech Republic)

Country = stri_extract_all(PhyloTree$tip.label, regex= "USA|Australia|South Africa|Israel|Russia|India|Madagascar|Azerbaijan|Ukraine|Czech Republic|Kenya", mode = "all", simplify =TRUE) 

#Country<-sub("\\w+\\s+\\|(\\w+|\\w+\\s\\w+)\\|(\\w+|\\w+\\s\\w+)\\|.+","\\2",PhyloTree$tip.label) #uses regex to capture country 

CountryGroups = split(PhyloTree$tip.label, Country)
Ccol = groupOTU(PhyloTree,CountryGroups)
str(Ccol) #Extra group category 0 is being created for some reason
```

```{r}
ggtree(Ccol, layout="rectangular", branch.length = "none", aes(color = group))
```

###Minimum Evolution Tree
```{r}
MEtree<-fastme.bal(seqDM)

Country1<-sub("\\w+\\s+\\|(\\w+|\\w+\\s\\w+)\\|(\\w+|\\w+\\s\\w+)\\|.+","\\2",MEtree$tip.label) #uses regex to capture country 

CountryGroups1 = split(MEtree$tip.label, Country)
MECcol = groupOTU(MEtree,CountryGroups1)
str(MECcol)
ggtree(MECcol, layout="rectangular",branch.length = "none", aes(color = group))
```

### Nucleotide sequence code 
```{r pressure, echo=FALSE}
NucSeq <- readDNAStringSet("./input/e_protein/WNV_ENucleotide_Seqs.fa")
NucSeqDF <- data.frame(NucSeq)
names(NucSeqDF) <- c("seq")
NucSeqDF <- cbind("WNV E Protein Variant" = rownames(NucSeqDF), NucSeqDF)
fullseqDNA<-sapply(NucSeqDF$seq,strsplit,split="")
names(fullseqDNA)<-NucSeqDF$`WNV E Protein Variant`  
fullseqDNA<- as.DNAbin(fullseqDNA)
```

```{r}
# Check sequence length - keep only if length is greater than 3000 AAs
SeqLen<-as.numeric(lapply(fullseqDNA,length)) 
qplot(SeqLen, binwidth = 50)+theme_bw() # one very large sequence.

KeepSeq<-SeqLen<1600
fullseqDNA<-seqAlign[SeqLen<1600,]
```


```{r}
seqAlign<-muscle(fullseqDNA,quiet=F)
alview(seqAlign)
monopic <- image.DNAbin(seqAlign, what = c("a","g","c","t","-"),col = viridis(5), ylab = "WNV Variants", xlab = "Sequence Length", show.labels = F, cex.lab = 0.5, legend = T)
```

### Country Phylogeny

```{r}
MEtree<-fastme.bal(seqDM)

Country1<-sub("\\w+\\s+\\|(\\w+|\\w+\\s\\w+)\\|(\\w+|\\w+\\s\\w+)\\|.+","\\2",MEtree$tip.label) #uses regex to capture country 

CountryGroups1 = split(MEtree$tip.label, Country)
MECcol = groupOTU(MEtree,CountryGroups1)
str(MECcol)
ggtree(MECcol, layout="rectangular",branch.length = "none", aes(color = group))
```

### Vector Phylogeny


```{r}
PhyloTree = nj(seqDM) #Build a phylogeny using neighbour-joining method 
```

```{r}
#Use regex and stringi to select strain vector from dataset
Vect = stri_extract_all(PhyloTree$tip.label, regex= "Accipiter|Corvus|Aves|Accipitridae|Anser|Aquila|Branta|Bubo|Buteo|Butorides|Cardinalis|Carpodacus|Ciconiidae|Colaptes|Columbia|Columbidae|Corvidae|Cyanocitta|Dumetella|Falco|Gallus|Laridae|Mimus|Passer|Passeridae|Passeriformes|Phalacrocorax|Phoenicopterus|Pica|Poecile|Quiscalus|Sciuridae|Turdus|Zenaida|Columba",
                        mode = "all", simplify =TRUE) 

Groups = split(PhyloTree$tip.label, Vect) #Separate vector from strain name

col = groupOTU(PhyloTree,Groups) #Create a group composed of vectors

str(col) #Display "col" information to ensure groups were properly formed

```

```{r}
ggtree(col, layout="rectangular",branch.length = "none",mapping = aes(color = group))
```


